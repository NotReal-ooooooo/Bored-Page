<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bored Page | Multi-player</title>
<style>
body {
  margin: 0;
  background: #111;
  color: #eee;
  font-family: monospace;
  display: flex; /* make a flex container for canvas + chat */
  height: 100vh;
}
#game {
  background: #222;
  border: 1px solid #333;
  margin: auto;
}
#chatSidebar {
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding: 10px;
  background: #222;
  border-left: 1px solid #333;
  width: 220px;
}
#chatInput {
  padding: 5px;
  background: #111;
  color: #eee;
  border: 1px solid #333;
  width: 100%;
}
#sendBtn {
  padding: 5px;
  background: #333;
  color: #eee;
  border: none;
  cursor: pointer;
}
#sendBtn:hover { background: #444; }
</style>

<body>
  <canvas id="game" width="900" height="600"></canvas>
  <div id="chatSidebar">
    <input id="chatInput" type="text" placeholder="Type message..." maxlength="40">
    <button id="sendBtn">Send</button>
  </div>
</body>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getDatabase, ref, push, update,
  onChildAdded, onChildChanged, onChildRemoved,
  onDisconnect, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyDHwRWR9aP00Kj4uKQUD2aXymca0SuoDfc",
  authDomain: "server-50ccc.firebaseapp.com",
  databaseURL: "https://server-50ccc-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "server-50ccc",
  storageBucket: "server-50ccc.firebasestorage.app",
  messagingSenderId: "210801120477",
  appId: "1:210801120477:web:48cad3a56e87b4c804f734",
  measurementId: "G-XG0CX1CV79"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const playersRef = ref(db, "players");

// ===== CANVAS =====
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== LOCAL STATE =====
let players = {};
let myRef = null;
let myId = null;

// ===== CREATE PLAYER =====
function createPlayer() {
  myRef = push(playersRef);
  myId = myRef.key;
  onDisconnect(myRef).remove();

  const start = {
    x: Math.random() * (canvas.width - 40),
    y: Math.random() * (canvas.height - 40),
    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
    chat: "",
    chatStart: 0,
    lastSeen: serverTimestamp()
  };

  // initialize interpolation properties
  players[myId] = {
    ...start,
    prevX: start.x,
    prevY: start.y,
    targetX: start.x,
    targetY: start.y,
    lastUpdate: performance.now()
  };

  update(myRef, start);
}
createPlayer();

window.addEventListener("beforeunload", () => {
  if (myRef) update(myRef, { lastSeen: serverTimestamp() });
});

// ===== LISTENERS =====
onChildAdded(playersRef, (snap) => {
  const d = snap.val();
  players[snap.key] = {
    ...d,
    prevX: d.x,
    prevY: d.y,
    targetX: d.x,
    targetY: d.y,
    lastUpdate: performance.now()
  };
});

onChildChanged(playersRef, (snap) => {
  const d = snap.val();
  const p = players[snap.key];
  if (!p) return;

  // smooth interpolation
  p.prevX = p.targetX;
  p.prevY = p.targetY;
  p.targetX = d.x;
  p.targetY = d.y;
  p.color = d.color;
  p.chat = d.chat || "";
  p.chatStart = d.chatStart || 0;
  p.lastUpdate = performance.now();
});

onChildRemoved(playersRef, (snap) => {
  delete players[snap.key];
});

// ===== INPUT =====
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

const speed = 5;
const SEND_INTERVAL = 100;
let lastSent = 0;

// ===== UPDATE PLAYER =====
function updatePlayer() {
  const me = players[myId];
  if (!me) return;

  let x = me.targetX;
  let y = me.targetY;

  if (keys["ArrowUp"] || keys["w"]) y -= speed;
  if (keys["ArrowDown"] || keys["s"]) y += speed;
  if (keys["ArrowLeft"] || keys["a"]) x -= speed;
  if (keys["ArrowRight"] || keys["d"]) x += speed;

  x = clamp(x, 0, canvas.width - 40);
  y = clamp(y, 0, canvas.height - 40);

  // update local interpolation
  me.prevX = me.targetX;
  me.prevY = me.targetY;
  me.targetX = x;
  me.targetY = y;
  me.lastUpdate = performance.now();

  const now = performance.now();
  if (now - lastSent > SEND_INTERVAL) {
    lastSent = now;
    update(myRef, { x, y, color: me.color, lastSeen: serverTimestamp() });
  }
}

// ===== CHAT HANDLING =====
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

sendBtn.onclick = () => {
  const text = chatInput.value.trim();
  if (!text) return;
  chatInput.value = "";

  const me = players[myId];
  if (!me) return;

  const now = Date.now();
  update(myRef, { chat: text, chatStart: now });

  setTimeout(() => {
    update(myRef, { chat: "", chatStart: 0 });
  }, 3000);
};

// ===== RENDER =====
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const now = performance.now();

  for (const id in players) {
    const p = players[id];
    if (!p) continue;

    // smooth interpolation
    const t = Math.min((now - p.lastUpdate) / 100, 1);
    const drawX = p.prevX + (p.targetX - p.prevX) * t;
    const drawY = p.prevY + (p.targetY - p.prevY) * t;

    // draw player
    ctx.fillStyle = p.color;
    ctx.fillRect(drawX, drawY, 40, 40);

    if (id === myId) {
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.strokeRect(drawX, drawY, 40, 40);
    }

    // draw chat
    if (p.chat) {
      const elapsed = Date.now() - (p.chatStart || 0);
      let alpha = 1;
      if (elapsed > 2000) alpha = 1 - (elapsed - 2000) / 1000;
      ctx.globalAlpha = Math.max(alpha, 0);
      ctx.fillStyle = "#fff";
      ctx.font = "14px monospace";
      ctx.textAlign = "center";
      ctx.fillText(p.chat, drawX + 20, drawY - 10 - (elapsed / 50));
      ctx.globalAlpha = 1;
    }
  }
}

// ===== MAIN LOOP =====
function loop() {
  updatePlayer();
  render();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>

