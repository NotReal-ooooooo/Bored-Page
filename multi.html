<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Virtual Chat | Bored Page</title>
  <link rel="icon" type="image/png" href="canvas.png">
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: monospace;
      display: flex;
      height: 100vh;
    }
    #game {
      background: #222;
      border: 1px solid #333;
      margin: auto;
      display: block;
    }
    #sidebar {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #1a1a1a;
      border-left: 1px solid #333;
      width: 220px;
    }
    #chatInput, #colorPicker {
      padding: 5px;
      background: #222;
      color: #eee;
      border: 1px solid #333;
      width: 100%;
    }
    #sendBtn, #spawnBtn {
      padding: 5px;
      background: #333;
      color: #eee;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    #sendBtn:hover, #spawnBtn:hover { background: #444; }
    #info {
      font-size: 13px;
      text-align: center;
      margin-bottom: 5px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <canvas id="game" width="900" height="600"></canvas>
  <div id="sidebar">
    <div id="info">ðŸŽ® Pick your color then spawn!</div>
    <input type="color" id="colorPicker" value="#00ffff">
    <button id="spawnBtn">Spawn Player</button>
    <hr style="width:100%; border-color:#333;">
    <input id="chatInput" type="text" placeholder="Type message..." maxlength="40">
    <button id="sendBtn">Send</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getDatabase, ref, push, update,
  onChildAdded, onChildChanged, onChildRemoved,
  onDisconnect, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyDHwRWR9aP00Kj4uKQUD2aXymca0SuoDfc",
  authDomain: "server-50ccc.firebaseapp.com",
  databaseURL: "https://server-50ccc-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "server-50ccc",
  storageBucket: "server-50ccc.firebasestorage.app",
  messagingSenderId: "210801120477",
  appId: "1:210801120477:web:48cad3a56e87b4c804f734",
  measurementId: "G-XG0CX1CV79"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const playersRef = ref(db, "players");

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let players = {};
let myRef = null;
let myId = null;
let chosenColor = "#00ffff";
let spawned = false;

// ====== UI ELEMENTS ======
const colorPicker = document.getElementById("colorPicker");
const spawnBtn = document.getElementById("spawnBtn");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const sidebar = document.getElementById("sidebar");

colorPicker.oninput = () => chosenColor = colorPicker.value;
spawnBtn.onclick = () => {
  if (!spawned) {
    createPlayer(chosenColor);
    spawnBtn.disabled = true;
    spawned = true;
  }
};

// ===== CREATE PLAYER =====
function createPlayer(color) {
  myRef = push(playersRef);
  myId = myRef.key;
  onDisconnect(myRef).remove();

  const start = {
    x: Math.random() * (canvas.width - 40),
    y: Math.random() * (canvas.height - 40),
    color: color,
    chat: "",
    chatStart: 0,
    lastSeen: serverTimestamp()
  };

  players[myId] = {
    ...start,
    prevX: start.x,
    prevY: start.y,
    targetX: start.x,
    targetY: start.y,
    lastUpdate: performance.now()
  };

  update(myRef, start);
}

window.addEventListener("beforeunload", () => {
  if (myRef) update(myRef, { lastSeen: serverTimestamp() });
});

// ===== LISTENERS =====
onChildAdded(playersRef, (snap) => {
  const d = snap.val();
  players[snap.key] = {
    ...d,
    prevX: d.x,
    prevY: d.y,
    targetX: d.x,
    targetY: d.y,
    lastUpdate: performance.now()
  };
});

onChildChanged(playersRef, (snap) => {
  const d = snap.val();
  const p = players[snap.key];
  if (!p) return;
  p.prevX = p.targetX;
  p.prevY = p.targetY;
  p.targetX = d.x;
  p.targetY = d.y;
  p.color = d.color;
  p.chat = d.chat || "";
  p.chatStart = d.chatStart || 0;
  p.lastUpdate = performance.now();
});

onChildRemoved(playersRef, (snap) => delete players[snap.key]);

// ===== MOVEMENT =====
const keys = {};
window.addEventListener("keydown", e => {
  keys[e.key] = true;
  handleMovementLock();
});
window.addEventListener("keyup", e => {
  keys[e.key] = false;
  handleMovementLock();
});

// Disable UI while moving
function handleMovementLock() {
  const moving =
    keys["ArrowUp"] || keys["ArrowDown"] ||
    keys["ArrowLeft"] || keys["ArrowRight"] ||
    keys["w"] || keys["a"] || keys["s"] || keys["d"];

  sidebar.style.pointerEvents = moving ? "none" : "auto";
}

function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

const speed = 5;
const SEND_INTERVAL = 100;
let lastSent = 0;

function updatePlayer() {
  if (!spawned || !players[myId]) return;

  const me = players[myId];
  let x = me.targetX, y = me.targetY;

  if (keys["ArrowUp"] || keys["w"]) y -= speed;
  if (keys["ArrowDown"] || keys["s"]) y += speed;
  if (keys["ArrowLeft"] || keys["a"]) x -= speed;
  if (keys["ArrowRight"] || keys["d"]) x += speed;

  x = clamp(x, 0, canvas.width - 40);
  y = clamp(y, 0, canvas.height - 40);

  me.prevX = me.targetX;
  me.prevY = me.targetY;
  me.targetX = x;
  me.targetY = y;
  me.lastUpdate = performance.now();

  const now = performance.now();
  if (now - lastSent > SEND_INTERVAL) {
    lastSent = now;
    update(myRef, { x, y, color: me.color, lastSeen: serverTimestamp() });
  }
}

// ===== CHAT =====
sendBtn.onclick = () => {
  const text = chatInput.value.trim();
  if (!text || !spawned) return;
  chatInput.value = "";

  const me = players[myId];
  if (!me) return;

  const now = Date.now();
  update(myRef, { chat: text, chatStart: now });

  setTimeout(() => {
    update(myRef, { chat: "", chatStart: 0 });
  }, 3000);
};

// ===== RENDER =====
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const now = performance.now();

  for (const id in players) {
    const p = players[id];
    if (!p) continue;

    const t = Math.min((now - p.lastUpdate) / 100, 1);
    const drawX = p.prevX + (p.targetX - p.prevX) * t;
    const drawY = p.prevY + (p.targetY - p.prevY) * t;

    ctx.fillStyle = p.color;
    ctx.fillRect(drawX, drawY, 40, 40);

    if (id === myId) {
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.strokeRect(drawX, drawY, 40, 40);
    }

    if (p.chat) {
      const elapsed = Date.now() - (p.chatStart || 0);
      let alpha = 1;
      if (elapsed > 2000) alpha = 1 - (elapsed - 2000) / 1000;
      ctx.globalAlpha = Math.max(alpha, 0);
      ctx.fillStyle = "#fff";
      ctx.font = "14px monospace";
      ctx.textAlign = "center";
      ctx.fillText(p.chat, drawX + 20, drawY - 10 - (elapsed / 50));
      ctx.globalAlpha = 1;
    }
  }
}

// ===== LOOP =====
function loop() {
  updatePlayer();
  render();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
